---
title: "Task 3: 基于RFM的客户价值分层分析"
output: html_notebook
---


在建立营销模型之前，需要对客户有初步的了解，RFM的分层方法是比较常用的方法。RFM的含义：

**R（Recency）最近一次消费时间**：表示用户最近一次消费距离现在的时间。消费时间越近的客户价值越大。1年前消费过的用户肯定没有1周前消费过的用户价值大。

**F（Frequency）消费频率**：消费频率是指用户在统计周期内购买商品的次数，经常购买的用户也就是熟客，价值肯定比偶尔来一次的客户价值大。

**M（Monetary）消费金额**：消费金额是指用户在统计周期内消费的总金额，体现了消费者为企业创利的多少，自然是消费越多的用户价值越大。

通过三个维度可以把客户分为8组：

```{r pressure, echo=FALSE, fig.cap="RFM客户分层图", out.width = '90%'}
knitr::include_graphics("RFM分层图.png")
```



## 任务
根据Task 2，在进行模型建立前我们首先删除非正常交易的449个样本(只在交易表中出现而没有在客户表中出现)，
并在交易表(trans)中将观察窗口(1998-1-1至1998-6-30)中的交易记录提取出来：
```{r include=FALSE}
library(tidyverse)
load("E:/实习/信用卡管理/Task 2/task2.RData")
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
trans_obj <- trans[!trans$account_id %in% trans_no_app, ] %>% 
  filter(date > as.Date("1998-01-01") & date < as.Date("1998-06-30"))

# 查看一共有多少账户在统计周期内进行了多少次交易
sprintf("一共有 %d 账户在统计周期内进行了 %d 交易", 
        length(unique(trans_obj$account_id)), nrow(trans_obj))
```
### Q1. 每一个客户的某种交易的R，F，M指标
分别提取不同交易类型的数据，
```{r echo=TRUE,highlight=TRUE}
trans_rfm <- trans_obj %>% group_by(account_id, operation) %>% 
               mutate(recency = max(date)) %>% mutate(frequency = n()) %>%
               mutate(monetary = sum(amount_num)) %>%
               select(account_id, operation, recency, frequency, monetary)
trans_rfm <- trans_rfm[!duplicated(trans_rfm), ]

rTime <- trans_obj %>% group_by(operation) %>% mutate(refertime = max(date)) %>%
  select(operation, refertime)
rTime <- rTime[!duplicated(rTime), ]

trans_rfm <- inner_join(trans_rfm, rTime, by = "operation")  
trans_rfm$rInternal <- as.integer(as.Date(trans_rfm$recency) - as.Date(trans_rfm$refertime))
trans_rfm <- select(trans_rfm, -c(refertime))

operation <- unique(trans_obj$operation)
for (op in operation) {
  assign(paste0("trans_", op), trans_rfm[trans_rfm$operation == op, ])
}

```
对于6类交易类型，我们分别计算了相应的R，F，M指标，并保存在相应文件中。
```{r include=FALSE}
trans_loan
trans_cash
trans_cc_debit
trans_collection
trans_remit
trans_
```


```{r include=FALSE}
# 定义一个绘图主题
mytheme <- theme(axis.text.x = element_text(angle = 30, vjust= 1, hjust = 1, size = 10),
                 axis.title.x=element_text(size=8),
                 axis.title.y=element_text(size=8),
                 panel.background = element_rect(fill = "white", color = "black"),
                 panel.grid.major.y = element_line(color = "grey", linetype= 1),
                 panel.grid.minor.y = element_line(color = "grey", linetype= 2),
                 panel.grid.minor.x = element_blank(), 
                 legend.position = "bottom")
```

分析loan交易对应的R，F，M指标的分布，

```{r echo=TRUE, message=FALSE, warning=FALSE}
## 绘制recency, frequency, monetary的直方图，观察其分布
r <- ggplot(trans_loan, aes(rInternal)) +
      geom_histogram(bins = 10) + mytheme
f <- ggplot(trans_loan, aes(frequency)) +
  geom_histogram(bins = 10) + mytheme
m <- ggplot(trans_loan, aes(monetary)) +
  geom_histogram(bins = 10) + mytheme
gridExtra::grid.arrange(r, f, m, ncol = 3)

```
通过上图可以看出，最近一次交易时间大多数发生在观察窗口结束时间的前一个月之内；交易频次大多是在5-10次之间，低频次交易的人数比高频词交易的人数多；交易总额集中在15万以内。



### Q2. 对三个维度，分别划分等级，列明等级划分标准，说明等级划分的理由，
**划分等级标准1**：对于原始R,F,M的取值，大于平均数认为“高等级”，小于平均数认为“低等级”。

我们以交易类型"loan"为例，按照平均值划分标准来划分客户等级。
```{r highlight=TRUE}
trans_loan$rankR <- ifelse(trans_loan$rInternal > mean(trans_loan$rInternal), "高", "低")
trans_loan$rankF <- ifelse(trans_loan$frequency > mean(trans_loan$frequency), "高", "低")
trans_loan$rankM <- ifelse(trans_loan$monetary > mean(trans_loan$monetary), "高", "低")

label <- vector("character", nrow(trans_loan))
trans_loan_lab <- within(trans_loan, {
  
  label[rankR == "高" & rankF == "高" & rankM == "高"] = "重要价值客户"
  label[rankR == "高" & rankF == "低" & rankM == "高"] = "重要发展客户"  
  label[rankR == "低" & rankF == "高" & rankM == "高"] = "重要保持客户"
  label[rankR == "低" & rankF == "低" & rankM == "高"] = "重要挽留客户"
  
  label[rankR == "高" & rankF == "高" & rankM == "低"] = "一般价值客户"
  label[rankR == "高" & rankF == "低" & rankM == "低"] = "一般发展客户"  
  label[rankR == "低" & rankF == "高" & rankM == "低"] = "一般保持客户"
  label[rankR == "低" & rankF == "低" & rankM == "低"] = "一般挽留客户"
    
})

trans_loan_lab %>% group_by(label) %>% 
  summarize(rmean = mean(rInternal), rmedian = median(rInternal), rsd = sd(rInternal),
            fmean = mean(frequency), fmedian = median(frequency), fsd = sd(frequency),
            mmean = mean(monetary),  mmedian = median(monetary),  msd = sd(monetary),
            .groups = "drop")

```

将8个客户组的recency，frequency，monetary的均值、中位数和方差，汇总如下：

  客户类型      R均值     R中位数     R标准差     F均值   F中位数  F标准差      M均值      M中位数     M标准差
------------   -------  -----------  ---------   ------- -------- --------    --------   -----------  ---------
重要价值客户    -9.96     -8          7.35        11.8      11        2.82     2.83e5      282949       105801  
重要发展客户   -18.0      -19         5.33        6.12      6        0.441    1.39e5       137180       18010  
重要保持客户   -36.8      -34         10.3        10.7      10        2.48     2.67e5      252152       90491  
重要挽留客户   -44.4      -42         16.9        5.90      6        0.889     1.66e5      159798       34315  
一般价值客户   -15.0      -16         6.68        10.1       9        2.25     6.43e4      62189        23062 
一般发展客户   -16.9      -18         6.18        5.78      6        1.33     6.77e4       73800        32636 
一般保持客户   -26        -26         0           9         9         0       1.03e5       102599           0
一般挽留客户   -85.4      -79.5       46.6        2.48      2        1.54     2.23e4       8400         28686 
     
: loan交易中客户R，F，M指标的统计量汇总


### Q3. 计算每个单元用户数和占比情况：

计算loan交易对应的客户分层情况，
```{r message=FALSE, warning=FALSE, include=FALSE}
loan_group <- cbind(count = table(trans_loan_lab$label), 
                    prop = round(table(trans_loan_lab$label) / nrow(trans_loan_lab), 4))
loan_group

```

将分层情况汇总如下表：

  客户类型        计数         占比       成交客户等级
------------    --------      --------   --------------
重要价值客户       395         0.1387        A级
重要发展客户       664         0.2331        A级
重要保持客户        50         0.0176        B级
重要挽留客户        41         0.0144        B级
一般价值客户       488         0.1713        B级
一般发展客户       901         0.3164        B级
一般保持客户         1         0.0004        C级
一般挽留客户       308         0.1081        C级

: loan交易客户分层情况统计表

绘制loan交易对应的客户分层条形图如下：
```{r echo=TRUE, message=FALSE, warning=FALSE}
# 绘制客户类型分布的条形图
ggplot(data = trans_loan_lab) + geom_bar(mapping = aes(x = label)) + 
  xlab("Customer stratification of loan operation") + mytheme
```

根据上图和表1可以看出,“一般保持客户”，“重要保持客户”和“重要挽留客户”非常少，说明两点问题：
(1) “一般保持客户”极少，“重要保持客户”非常少，说明很少出现最近一次交易距离远但交易频次高的情况。
(2) “重要挽留客户”非常少，说明很少出现最近一次交易距离远，交易频次低但是交易金额大的，对照“一般挽留客户”的人数，可以发现最近一次交易距离远，交易频次低的客户，通常交易金额也低，很少会单次进行大额交易。

另外，A及客户（“重要价值客户”和“重要发展客户”）数量可观，可以针对这些客户提供针对性的服务。“一般发展客户”最多，这类客户的交易金额和频次都低，可能是在临近观察期结束的时间内进行了少数交易。尽管这类客户价值有限，但是数量最大，也可以针对这类客户做营销。


下面按照类似的操作，将其余5种交易类型的客户分层情况分别汇总至表 3-7：
```{r include=FALSE}
### function
getLabel <- function(data) {
  
  data$rankR <- ifelse(data$rInternal > mean(data$rInternal), "高", "低")
  data$rankF <- ifelse(data$frequency > mean(data$frequency), "高", "低")
  data$rankM <- ifelse(data$monetary  > mean(data$monetary), "高", "低")
  
  label <- vector("character", nrow(data))
  data_lab <- within(data, {
    
    label[rankR == "高" & rankF == "高" & rankM == "高"] = "重要价值客户"
    label[rankR == "高" & rankF == "低" & rankM == "高"] = "重要发展客户"  
    label[rankR == "低" & rankF == "高" & rankM == "高"] = "重要保持客户"
    label[rankR == "低" & rankF == "低" & rankM == "高"] = "重要挽留客户"
    
    label[rankR == "高" & rankF == "高" & rankM == "低"] = "一般价值客户"
    label[rankR == "高" & rankF == "低" & rankM == "低"] = "一般发展客户"  
    label[rankR == "低" & rankF == "高" & rankM == "低"] = "一般保持客户"
    label[rankR == "低" & rankF == "低" & rankM == "低"] = "一般挽留客户"
    
  })
  
  data_group <- cbind(count = table(data_lab$label), 
                      prop = round(table(data_lab$label) / nrow(data_lab), 4))
  return(data_group)
  
}

## cash
print("cash交易的客户分层表为：")
getLabel(trans_cash)

## remit
print("remit交易的客户分层表为：")
getLabel(trans_remit)

## collection
print("collection交易的客户分层表为：")
getLabel(trans_collection)

##cc_debit
print("debit交易的客户分层表为：")
getLabel(trans_cc_debit)

## unknown
print("未知交易的客户分层表为：")
getLabel(trans_)

```


  客户类型        计数         占比       成交客户等级
------------    --------      --------  ----------------
重要价值客户      740          0.1837        A级
重要发展客户      229          0.0568        A级
重要保持客户      317          0.0787        B级
重要挽留客户      167          0.0414        B级
一般价值客户      567          0.1407        B级
一般发展客户      685          0.1700        B级
一般保持客户      347          0.0861        C级
一般挽留客户      977          0.2425        C级

: cash交易客户分层情况统计表


  客户类型        计数         占比       成交客户等级
------------    --------      --------  ----------------
重要价值客户      550          0.1740        A级
重要发展客户      276          0.0873        A级
重要保持客户      136          0.0430        B级
重要挽留客户      315          0.0997        B级
一般价值客户      391          0.1237        B级
一般发展客户      588          0.1860        B级
一般保持客户      172          0.0544        C级
一般挽留客户      733          0.2319        C级

: remit交易客户分层情况统计表


  客户类型        计数         占比       成交客户等级
------------    --------      --------  ---------------
重要发展客户       158         0.1084      A级
重要挽留客户       215         0.1476      B级
一般发展客户       564         0.3871      B级
一般挽留客户       520         0.3569      C级

: collection交易客户分层情况统计表


  客户类型        计数         占比        成交客户等级
------------    --------      --------   ---------------
重要价值客户      128          0.2759       A级
重要发展客户       11          0.0237       A级
重要保持客户       57          0.1228       B级
重要挽留客户        6          0.0129       B级
一般价值客户        9          0.0194       B级
一般发展客户      118          0.2543       B级
一般保持客户       11          0.0237       C级
一般挽留客户      124          0.2672       C级

: debit交易客户分层情况统计表

  客户类型        计数         占比        成交客户等级
------------    --------      --------   ---------------
重要价值客户       101         0.0253       A级
重要发展客户      1604         0.4013       A级
重要挽留客户         1         0.0003       B级
一般价值客户        36         0.0090       B级
一般发展客户      2224         0.5564       B级
一般保持客户         1         0.0003       C级
一般挽留客户        30         0.0075       C级

: unknown交易客户分层情况统计表



### 两两交叉分析

针对R，F，M中的两两指标进行分析，观察其是否存在某种规律。绘制量两两指标对应的散点图：
```{r echo=FALSE, fig.height=4}
# 交叉分析图
rm <- ggplot(trans_loan_lab,aes(monetary,rInternal)) +
  geom_point(shape = 21, fill = 'steelblue',size = 1)
fm <- ggplot(trans_loan_lab,aes(monetary,frequency)) +
  geom_point(shape = 21, fill = 'steelblue',size = 1)  
rf <- ggplot(trans_loan_lab,aes(frequency,rInternal)) +
  geom_point(shape = 21, fill = 'steelblue',size = 1)  
gridExtra::grid.arrange(rm,fm,rf, ncol=1)
```
根据recency与monetary的子图可以看出，交易金额较高的人，最近一次交易的时间距离观察窗口结束的时间也较近，说明大金额交易的客户不太可能长时间不进行交易。而交易金额很低的人，最近一次交易时间相对均匀分布在(0, 200)天之间，说明loan交易总额很低的客户中，有一部分长时间不再进行loan交易，可能处于流失的状态或者时价值较低的客户。

根据frequency和monetary的子图可以看出，交易频次和总金额存在近似的线性关系。总体来看，当交易金额增大时，频次也增大。不过在交易金额较小(10万以内)时，有部分用户的交易频次也较高。

根据recency和frequency的子图可以看出，交易频次高的客户，最近一次交易间隔时间短，随着交易频次的升高，最近一次交易的时间逐渐也越近。而交易频次很低的这部分客户，可能只是在观查窗口的某个时间内随机交易了1-2次。


## 附录
这里给出其他的等级划分标准，以便对比不同等级划分标准下的分层结果。以loan交易为例进行分析，其余5种交易类型的等级划分结果可以类似给出。

**等级划分标准2** 采用分位数方法进行客户分层。根据分位数分别对rInternal(最近一次交易距离天数)，frequency(交易频次)， monetary(交易总金额)进行打分，记为新的R，F，M指标。具体来说，`rInternal`表示某客户最近一次交易日期距离参照日期的天数，为负值，因此`rInternal`越大，得分越高； `frequency`越大，得分越高；`monetary`越大，得分越高。
具体操作如下：
```{r message=FALSE, warning=FALSE}
# 距离天数越大，rInternal越大，得分越高
qr <- unique(quantile(trans_loan$rInternal))
qf <- unique(quantile(trans_loan$frequency))
qm <- unique(quantile(trans_loan$monetary))

trans_loan_rfm <- trans_loan %>% 
  mutate(Rece = as.integer(cut(rInternal, breaks = c(-Inf, qr, Inf), labels = 1:(length(qr)+1)))) %>%
  mutate(Freq = as.integer(cut(frequency, breaks = c(-Inf, qf, Inf), labels = 1:(length(qf)+1)))) %>%
  mutate(Mone = as.integer(cut(monetary, breaks = c(-Inf, qm, Inf), labels = 1:(length(qm)+1)))) %>%
  select(-c(rankR, rankF, rankM, operation))


```

根据R，F，M的得分对客户进行分类，高于平均值判定为“高”，低于平均值判定为“低”。
```{r message=FALSE, warning=FALSE}
  trans_loan_rfm$rankR <- ifelse(trans_loan_rfm$Rece > mean(trans_loan_rfm$Rece), "高", "低")
  trans_loan_rfm$rankF <- ifelse(trans_loan_rfm$Freq > mean(trans_loan_rfm$Freq), "高", "低")
  trans_loan_rfm$rankM <- ifelse(trans_loan_rfm$Mone > mean(trans_loan_rfm$Mone), "高", "低")
  
  label <- vector("character", nrow(trans_loan_rfm))
  rfm_lab <- within(trans_loan_rfm, {
    
    label[rankR == "高" & rankF == "高" & rankM == "高"] = "重要价值客户"
    label[rankR == "高" & rankF == "低" & rankM == "高"] = "重要发展客户"  
    label[rankR == "低" & rankF == "高" & rankM == "高"] = "重要保持客户"
    label[rankR == "低" & rankF == "低" & rankM == "高"] = "重要挽留客户"
    
    label[rankR == "高" & rankF == "高" & rankM == "低"] = "一般价值客户"
    label[rankR == "高" & rankF == "低" & rankM == "低"] = "一般发展客户"  
    label[rankR == "低" & rankF == "高" & rankM == "低"] = "一般保持客户"
    label[rankR == "低" & rankF == "低" & rankM == "低"] = "一般挽留客户"
    
  })
  
  rfm_lab
  
```

汇总统计各个客户组的人数和占比情况，绘制相应的条形图：
```{r message=FALSE, warning=FALSE, include=FALSE}
app_group <- cbind(count = table(rfm_lab$label), 
                    prop = round(table(rfm_lab$label) / nrow(rfm_lab), 4))
app_group
```

  客户类型        计数         占比       成交客户等级
------------    --------      ---------  ---------------
重要价值客户       431         0.1513       A级
重要发展客户       253         0.0888       A级
重要保持客户       225         0.0790       B级
重要挽留客户       514         0.1805       B级
一般价值客户       332         0.1166       B级
一般发展客户       233         0.0818       B级
一般保持客户       290         0.1018       C级
一般挽留客户       570         0.2001       C级

```{r message=FALSE, warning=FALSE}
ggplot(data = rfm_lab) + geom_bar(mapping = aes(x = label)) + mytheme
```
汇总各个客户组的recency，frequency，monetary的均值和中位数
```{r message=FALSE, warning=FALSE}
rfm_lab %>% group_by(label) %>% 
  summarize(rmean = mean(rInternal), rmedian = median(rInternal), rsd = sd(rInternal),
            fmean = mean(frequency), fmedian = median(frequency), fsd = sd(frequency),
            mmean = mean(monetary),  mmedian = median(monetary),  msd = sd(monetary),
            .groups = "drop")

```

将8个客户组的recency，frequency，monetary的均值、中位数和方差，汇总如下：

  客户类型      R均值     R中位数     R标准差     F均值   F中位数   F标准差     M均值        M中位数      M标准差
------------ ---------  -----------  ---------  -------- --------- ---------  -----------   -----------  ---------
重要价值客户   -7.54       -6          5.45       10.8       11       3.22       250445         237729      115912
重要发展客户   -14.5       -16         4.06       5.89       6        0.441      130556         130331      20379
重要保持客户   -25.8       -22         9.86       9.39       8        2.57       197198         164364      98094
重要挽留客户   -22.9       -22         8.29       5.92       6        0.352      132051         131622      19831
一般价值客户   -11.3       -12         5.27       10.1       9        2.79       58062          58297       21313
一般发展客户   -10.9       -14         5.80       4.77       6        1.62       45204          42800       31885
一般保持客户   -21.1       -21         2.10       8.36       8        1.43       64369          63589       17823
一般挽留客户   -55.4       -26         47.1       3.90       4        2.05       38848          34541       32813

: loan交易中客户R，F，M指标的统计量汇总--分位数法



**等级划分标准3** 采用聚类方法进行客户分层。这里做一个简单的例子提供参考，由于数据本身比较简单，根据RFM三个指标的话使用均值或者分位数的分层方法就足够。进行聚类前的基本操作有(可选)：
(1) R，F，M三个指标标准化;
(2) R，F，M三个指标加权; 
(3) 加权综合RFM指标;

根据以上操作得到的新指标进行K-Means聚类并作结果分析。

具体来说，我们首先标准化R，F，M三个指标，根据R，F，M三个指标对客户分层的重要程度加权得到新的RFM指标，这里我们举例对R赋权0.2，对F赋权0.3，对M赋权0.5。利用加权后的特征进行聚类。聚类后将每个类别中心的R，F，M值分别与入模数据的R，F，M均值作对比，得到客户的类型。

```{r message=FALSE, warning=FALSE}
loan_model <- trans_loan[, c("rInternal", "frequency", "monetary")]
loan_new <- apply(loan_model, 2, scale) %>% as_tibble() %>% mutate(WZR = 0.2*rInternal) %>%
  mutate(WZF = 0.3*frequency) %>% mutate(WZM = 0.5*monetary) %>% select(WZR, WZF, WZM)

if(!require(factoextra)) {install.packages("factoextra"); library(factoextra)}

km_loan <- kmeans(loan_new, 8)
loan_clust <- tibble(loan_new, clust = km_loan$cluster)

##对比每类客户的RFM均值与总的RFM均值，大于总平均值记为“高”， 小于总平均值记为“低”
clust_center <- as_tibble(km_loan$centers)
clust_center <- clust_center %>% 
  mutate(rankR = ifelse(clust_center[["WZR"]] > apply(loan_new, 2, median)[1], "高", "低")) %>%
  mutate(rankF = ifelse(clust_center[["WZF"]] > apply(loan_new, 2, median)[2], "高", "低")) %>%
  mutate(rankM = ifelse(clust_center[["WZM"]] > apply(loan_new, 2, median)[3], "高", "低")) 

custom <- vector("character", length = 8)
clust_center <- within(clust_center, {
    custom[rankR == "高" & rankF == "高" & rankM == "高"] = "重要价值客户"
    custom[rankR == "高" & rankF == "低" & rankM == "高"] = "重要发展客户"  
    custom[rankR == "低" & rankF == "高" & rankM == "高"] = "重要保持客户"
    custom[rankR == "低" & rankF == "低" & rankM == "高"] = "重要挽留客户"
    
    custom[rankR == "高" & rankF == "高" & rankM == "低"] = "一般价值客户"
    custom[rankR == "高" & rankF == "低" & rankM == "低"] = "一般发展客户"  
    custom[rankR == "低" & rankF == "高" & rankM == "低"] = "一般保持客户"
    custom[rankR == "低" & rankF == "低" & rankM == "低"] = "一般挽留客户"
})

clust_refer <- tibble(clust = 1:8, custom = clust_center$custom)

loan_clust <- inner_join(loan_clust, clust_refer, by = "clust")

ggplot(data = loan_clust) +
       geom_bar(mapping=aes(x = custom)) + mytheme
```

### 总结
1. 客户细分的方法有很多，这里使用RFM模型对客户进行细分，是最基本客户划分方法，只针对客户的交易近度(Recency)、交易频率(Frequency)、交易金额(Monetary)进行统计，来体现出一个客户的粘性以及活跃度。还可以根据客户的风险来进行客户细分。

2. “重要发展客户”是指最近在进行交易，交易金额高，但交易频次不高的客户，说明客户具有财富价值，经常进行大额交易，是非常好的营销对象，可以推销产品.

3. “一般发展客户”和“一般价值客户”的交易金额低，不体现较大的价值。对于这类客户，银行所提供的服务相对较少，很多银行把他们划分到低优先级，在做业务的时候，不会将他们放在靠前位置。一般来说优先级高的都是当前很有价值或者是曾经很有价值的客户。